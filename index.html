<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Utdelningsportfölj - Enkel version</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { max-width:900px; margin:30px auto; padding:20px; background:#1e1e1e; color:#f0f0f0; font-family:Inter,sans-serif; border-radius:10px; transition:background 0.3s,color 0.3s; }
    h1 { margin-bottom:5px; }
    .note { font-size:0.85em; color:#ccc; margin-bottom:20px; }
    form { display:grid; grid-template-columns:1fr 80px 100px 100px 150px 150px auto; gap:10px; align-items:end; margin-bottom:20px; }
    input, select, button { padding:8px; border-radius:6px; border:1px solid #555; background:#2a2a2a; color:#fff; font-family:inherit; font-size:14px; }
    button { border:0; background:#2563eb; cursor:pointer; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:8px; text-align:left; border-bottom:1px solid #333; vertical-align:middle; }
    tfoot td { font-weight:bold; }
    .breakdown { margin-top:20px; padding:12px; background:#2a2a2a; border-radius:8px; }
    .delete-btn { background:#dc2626; padding:4px 6px; border-radius:4px; cursor:pointer; color:#fff; border:none; }
    .editable { cursor:pointer; background-color:#2e2e2e; border-radius:4px; transition:background 0.2s, box-shadow 0.2s; position:relative; }
    .editable:hover { background-color:#3a3a3a; }
    .editable:focus { outline:none; background-color:#334155; box-shadow:0 0 0 2px #2563eb; }
    .editable::after { content:'✏️'; position:absolute; right:6px; top:4px; font-size:12px; opacity:0.6; }
    .month-grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:6px; font-size:14px; }
    .month-grid div { padding:4px; background:#3a3a3a; border-radius:4px; text-align:center; cursor:pointer; position:relative; }
    .months-checkboxes { display:flex; flex-wrap:wrap; gap:5px; max-height:120px; overflow-y:auto; padding:4px; border:1px solid #555; border-radius:6px; background:#2a2a2a; margin-bottom:10px; }
    .months-checkboxes label { font-size:14px; cursor:pointer; }
    .tooltip { position:absolute; background:#2563eb; color:#fff; padding:6px 10px; border-radius:6px; display:none; z-index:10; font-size:13px; }
    .flag { width:20px; height:14px; display:inline-block; margin-right:6px; vertical-align:middle; background-size:cover; border:1px solid #555; border-radius:2px; }
  </style>
</head>
<body>
  <h1>Utdelningsportfölj</h1>
  <div class="note">Diverse källskatter är INTE medräknade</div>

  <form id="portfolioForm">
    <input id="company" placeholder="Bolag" required />
    <input id="shares" type="number" min="0" step="1" placeholder="Antal" required />
    <input id="dividend" type="number" min="0" step="0.01" placeholder="Utd/aktie" required />
    <select id="frequency">
      <option value="1">1/år</option>
      <option value="2">2/år</option>
      <option value="4">4/år</option>
      <option value="12">12/år</option>
    </select>
    <select id="currency">
      <option value="SEK">SEK</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="GBP">GBP</option>
      <option value="NOK">NOK</option>
      <option value="DKK">DKK</option>
    </select>
    <div class="months-checkboxes" id="months">
      <label><input type="checkbox" value="0">Jan</label>
      <label><input type="checkbox" value="1">Feb</label>
      <label><input type="checkbox" value="2">Mar</label>
      <label><input type="checkbox" value="3">Apr</label>
      <label><input type="checkbox" value="4">Maj</label>
      <label><input type="checkbox" value="5">Jun</label>
      <label><input type="checkbox" value="6">Jul</label>
      <label><input type="checkbox" value="7">Aug</label>
      <label><input type="checkbox" value="8">Sep</label>
      <label><input type="checkbox" value="9">Okt</label>
      <label><input type="checkbox" value="10">Nov</label>
      <label><input type="checkbox" value="11">Dec</label>
    </div>
    <button type="submit">Lägg till</button>
  </form>

  <table id="portfolioTable">
    <thead>
      <tr>
        <th>Bolag</th><th>Antal ✏️</th><th>Utd/aktie ✏️</th><th>Utdelningar/år</th><th>Valuta</th><th>Årlig utdelning (SEK)</th><th>Kvartal</th><th>Månad</th><th>Ta bort</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr><td colspan="8" style="text-align:right">Totalt (SEK):</td><td id="total">0</td></tr>
    </tfoot>
  </table>

  <div class="breakdown" id="monthlyBreakdown">
    <h3>Utdelning per månad (SEK)</h3>
    <canvas id="dividendChart" height="100"></canvas>
    <div id="monthSums" class="month-grid"></div>
  </div>

  <div id="tooltip" class="tooltip"></div>

  <script>
    const exchangeRates = { 'SEK':1, 'USD':11.5, 'EUR':12.3, 'GBP':14.7, 'NOK':1.25, 'DKK':1.65 };
    const currencyFlags = { 'SEK':'https://flagcdn.com/se.svg', 'USD':'https://flagcdn.com/us.svg', 'EUR':'https://flagcdn.com/eu.svg', 'GBP':'https://flagcdn.com/gb.svg', 'NOK':'https://flagcdn.com/no.svg', 'DKK':'https://flagcdn.com/dk.svg' };

    let portfolio = JSON.parse(localStorage.getItem('portfolio')||'[]');

    const tbody = document.querySelector('#portfolioTable tbody');
    const totalCell = document.getElementById('total');
    const monthSums = document.getElementById('monthSums');
    const tooltip = document.getElementById('tooltip');
    const form = document.getElementById('portfolioForm');
    let chart;

    function savePortfolio(){ localStorage.setItem('portfolio', JSON.stringify(portfolio)); }

    function renderChart(monthTotals){
      const ctx = document.getElementById('dividendChart');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'bar',
        data:{
          labels:['Jan','Feb','Mar','Apr','Maj','Jun','Jul','Aug','Sep','Okt','Nov','Dec'],
          datasets:[{ label:'Utdelning (SEK)', data:monthTotals, borderWidth:1 }]
        },
        options:{ plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function renderTable(){
      tbody.innerHTML = '';
      let total = 0;
      const monthTotals = Array(12).fill(0);
      const monthDetails = Array.from({length:12},()=>[]);

      portfolio.forEach((item,index)=>{
        if(!item.months) item.months = [];
        const tr = document.createElement('tr');
        const annualSEK = item.shares*item.dividend*item.freq*exchangeRates[item.currency];
        const quarterlySEK = (item.freq===4)?(annualSEK/4).toFixed(2):'';
        const months = item.months.length>0?item.months:Array.from({length:item.freq},(_,i)=>i);

        months.forEach(m=>{ monthTotals[m] += annualSEK/months.length; monthDetails[m].push(`${item.company}: ${(annualSEK/months.length).toFixed(2)} SEK`); });
        const monthlyCellContent = (item.freq===12)?(annualSEK/12).toFixed(2):'';

        tr.innerHTML = `<td><span class='flag' style="background-image:url('${currencyFlags[item.currency]}')"></span>${item.company}</td>
          <td class='editable' data-field='shares' data-index='${index}' contenteditable='true'>${item.shares}</td>
          <td class='editable' data-field='dividend' data-index='${index}' contenteditable='true'>${item.dividend}</td>
          <td>${item.freq}/år</td>
          <td>${item.currency}</td>
          <td>${annualSEK.toFixed(2)}</td>
          <td>${quarterlySEK}</td>
          <td>${monthlyCellContent}</td>
          <td><button class='delete-btn'>Ta bort</button></td>`;

        tbody.appendChild(tr);
        tr.querySelector('.delete-btn').addEventListener('click',()=>{ portfolio.splice(index,1); savePortfolio(); renderTable(); });
        tr.querySelectorAll('.editable').forEach(cell=>{
          cell.addEventListener('blur',()=>{
            const field = cell.dataset.field;
            const idx = parseInt(cell.dataset.index);
            const newVal = parseFloat(cell.textContent);
            if(!isNaN(newVal)&&newVal>=0){ portfolio[idx][field] = newVal; savePortfolio(); renderTable(); } else { renderTable(); }
          });
        });
        total += annualSEK;
      });

      totalCell.textContent = total.toFixed(2);
      monthSums.innerHTML = '';
      monthTotals.forEach((val,i)=>{
        const monthDiv = document.createElement('div');
        monthDiv.textContent = `${['Jan','Feb','Mar','Apr','Maj','Jun','Jul','Aug','Sep','Okt','Nov','Dec'][i]}: ${val.toFixed(2)} SEK`;
        monthDiv.addEventListener('mouseenter', e=>{ tooltip.style.display='block'; tooltip.style.left=e.pageX+10+'px'; tooltip.style.top=e.pageY+10+'px'; tooltip.innerHTML=monthDetails[i].join('<br>'); });
        monthDiv.addEventListener('mouseleave', ()=>{ tooltip.style.display='none'; });
        monthSums.appendChild(monthDiv);
      });
      renderChart(monthTotals);
    }

    form.addEventListener('submit', e=>{
      e.preventDefault();
      const company = document.getElementById('company').value.trim();
      const shares = parseFloat(document.getElementById('shares').value);
      const dividend = parseFloat(document.getElementById('dividend').value);
      const freq = parseInt(document.getElementById('frequency').value);
      const currency = document.getElementById('currency').value;
      const months = Array.from(document.querySelectorAll('#months input:checked')).map(input=>parseInt(input.value));

      portfolio.push({company, shares, dividend, freq, currency, months});
      savePortfolio();
      renderTable();
      form.reset();
    });

    renderTable();
  </script>
</body>
</html>
